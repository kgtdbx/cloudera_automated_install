LOC=`pwd`
PROPS="cluster_cloud.props"
source $LOC/$PROPS 2>/dev/null
NUMBER_OF_HOSTS=`grep HOST $LOC/$PROPS|grep -v SERVICES|wc -l`
LAST_HOST=`grep HOST $LOC/$PROPS|grep -v SERVICES|head -n $NUMBER_OF_HOSTS|tail -1|cut -d'=' -f2`
grep HOST $LOC/$PROPS|grep -v SERVICES|grep -v $LAST_HOST|cut -d'=' -f2 > $LOC/list



cluster_info()
{
#Start of function
BASE_URL="http://$REPO_SERVER/repo/cdh/parcels/$OS/"

echo "{
  \"cdhVersion\" : \"5.14.0\",
  \"displayName\" : \"demo\",
  \"cmVersion\" : \"5.14.0\",
  \"repositories\" : [ \"$BASE_URL\" ],
  \"products\" : [ {
    \"version\" : \"$PARCEL_VERSION\",
    \"product\" : \"CDH\"
  }],"


#End of function
}


hosttemplate()
{
#Start of function

LAST_HST_NAME=`grep 'HOST[0-9]*' $LOC/$PROPS|grep -v SERVICES|tail -1|cut -d'=' -f1`
for HOST in `grep -w 'HOST[0-9]*' $LOC/$PROPS|tr '\n' ' '`
do
   HST_NAME_VAR=`echo $HOST|cut -d'=' -f1`
echo "  \"hostTemplates\" : [ {
    \"refName\" : \"HostTemplate-1-from-$HOST.$DOMAIN_NAME\",
    \"cardinality\" : 1,"
                SVC=`grep $HST_NAME_VAR"_SERVICES" $LOC/$PROPS|cut -d'=' -f2 |sed 's/,/", "/g'|sed -e 's/[^ ]*CLIENT"[^ ]*//ig'`
    echo "\"roleConfigGroupsRefNames\" : [ $SVC ]"
done
#End of function
}

hostmap()
{
#Start of function

echo "\"instantiator\" : {
    \"clusterName\" : \"$CLUSTERNAME\",
    \"hosts\" : [ {"

for HOST in `cat list`
do

      echo "\"hostName\" : \"$HOST.$DOMAIN_NAME\",
      \"hostTemplateRefName\" : \"HostTemplate-1-from-$HOST.$DOMAIN_NAME\"
    }, {"
done
      echo "\"hostNameRange\" : \"$LAST_HOST.$DOMAIN_NAME\",
      \"hostTemplateRefName\" : \"HostTemplate-0-from-$LAST_HOST.$DOMAIN_NAME\"
    } 
    ]
  }
}"
#End of function
}

cluster_info
hosttemplate
hostmap
